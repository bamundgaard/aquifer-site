<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aquifer Datasets Browser</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111824; --muted:#6b7a90; --text:#e8eef6; --accent:#7ab7ff; --accent-2:#96e6b3; --border:#1b2636;
    }
    *{box-sizing:border-box}
    body{margin:0; font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:linear-gradient(180deg,#0b0f14 0%,#0d121a 120%);}    
    .app{display:grid; grid-template-columns: 320px 1fr; grid-template-rows:auto 1fr; height:100dvh}
    header{grid-column:1/3; display:flex; gap:12px; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border); background:#0e141d; position:sticky; top:0; z-index:5}
    header .brand{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px}
    header .brand .dot{width:10px; height:10px; border-radius:50%; background:radial-gradient(circle at 30% 30%, var(--accent-2), var(--accent)); box-shadow:0 0 16px rgba(122,183,255,.55)}
    header input[type="search"]{flex:1; max-width:720px; background:#0b1119; border:1px solid var(--border); border-radius:10px; padding:10px 12px; color:var(--text)}
    header .pill{border:1px solid var(--border); background:#0b1119; color:var(--muted); border-radius:999px; padding:8px 10px; font-size:12px}

    .left{border-right:1px solid var(--border); background:var(--panel); overflow:auto}
    .filters{padding:12px 12px 4px; display:flex; flex-wrap:wrap; gap:6px; position:sticky; top:57px; background:var(--panel); z-index:4}
    .chip{cursor:pointer; border:1px solid var(--border); color:var(--muted); background:#0b1119; padding:6px 10px; border-radius:999px; font-size:12px; user-select:none}
    .chip.active{border-color:var(--accent); color:var(--text)}

    .tree{padding:8px 0}
    .group{padding:8px 12px}
    .group h3{margin:10px 0 6px; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em}
    .file{display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; cursor:pointer; color:var(--text); text-decoration:none}
    .file:hover{background:#0f1622}
    .file .icon{width:22px; text-align:center; opacity:.85}
    .meta{margin-left:auto; color:var(--muted); font-variant-numeric:tabular-nums}

    .right{position:relative; overflow:auto}
    .preview{height:100%; display:grid; grid-template-rows:auto 1fr;}
    .bar{display:flex; align-items:center; gap:10px; padding:12px 16px; border-bottom:1px solid var(--border); background:var(--panel); position:sticky; top:57px; z-index:3}
    .bar .path{color:var(--muted); font-size:12px}
    .bar .btn{border:1px solid var(--border); background:#0b1119; color:var(--text); border-radius:8px; padding:6px 10px; cursor:pointer}
    .viewer{padding:0; overflow:auto}
    .viewer iframe, .viewer object{width:100%; height:100%; border:0}
    .viewer .pad{padding:18px}
    pre{background:#0b1119; border:1px solid var(--border); padding:16px; border-radius:12px; overflow:auto}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:13px}

    .empty{opacity:.7; color:var(--muted); padding:24px}

    @media (max-width: 980px){
      .app{grid-template-columns:1fr; grid-template-rows:auto auto 1fr}
      .left{grid-row:2}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand"><span class="dot" aria-hidden="true"></span> Aquifer Datasets</div>
      <input id="q" type="search" placeholder="Search filenames, paths, or titles (⌘/Ctrl+K)" autocomplete="off" />
      <div class="pill" title="Keyboard help">?
      </div>
    </header>

    <aside class="left">
      <div class="filters" id="filters"></div>
      <nav id="tree" class="tree" aria-label="Files"></nav>
    </aside>

    <main class="right">
      <section class="preview">
        <div class="bar">
          <div class="path" id="crumbs">Select a file to preview…</div>
          <button class="btn" id="openRaw" disabled>Open raw</button>
          <button class="btn" id="copyLink" disabled>Copy link</button>
        </div>
        <div class="viewer" id="viewer">
          <div class="empty pad">No file selected.</div>
        </div>
      </section>
    </main>
  </div>

  <script>
  ;(() => {
    const state = {
      files: [], // {path, url?, size?, type?, title?}
      filters: new Set(),
      activeChip: 'All',
      q: ''
    };

    const el = sel => document.querySelector(sel);
    const tree = el('#tree');
    const filtersEl = el('#filters');
    const q = el('#q');
    const viewer = el('#viewer');
    const crumbs = el('#crumbs');
    const openRaw = el('#openRaw');
    const copyLink = el('#copyLink');

    // --- UTIL ---
    const fmtBytes = n => {
      if (!Number.isFinite(n) || n <= 0) return '';
      const u = ['B','KB','MB','GB','TB'];
      const e = Math.floor(Math.log(n)/Math.log(1024));
      return (n/Math.pow(1024,e)).toFixed( e ? 1 : 0) + ' ' + u[e];
    };
    const ext = p => (p.split('.').pop() || '').toLowerCase();
    const byPath = (a,b) => a.path.localeCompare(b.path);
    const hashFor = path => '#file=' + encodeURIComponent(path);
    const getHashFile = () => {
      const m = location.hash.match(/#file=([^&]+)/);
      return m ? decodeURIComponent(m[1]) : null;
    }

    // Category derivation: read from manifest.file.category OR infer from path segment like Datasets/ACAI/<Category>/...
    const deriveCategory = (f) => {
      if (f.category) return f.category;
      const parts = f.path.split('/');
      // Heuristic: look for common buckets under ACAI or Datasets
      const idx = Math.max(parts.indexOf('ACAI'), parts.indexOf('Datasets'));
      if (idx >= 0 && parts[idx+1]) return parts[idx+1];
      // fallback to first dir
      return parts[0] || 'Root';
    };

    const iconFor = (pOrType) => {
      const e = (pOrType?.includes('/') ? pOrType.split('/').pop() : ext(pOrType)).toLowerCase();
      if (/pdf/.test(pOrType)) return '📄';
      if (/(png|jpg|jpeg|gif|webp|svg)$/.test(e)) return '🖼️';
      if (/(mp4|webm|mov|m4v|avi)$/.test(e)) return '🎞️';
      if (/(mp3|wav|flac|m4a|ogg)$/.test(e)) return '🎧';
      if (/(csv|tsv|xlsx|xls)$/.test(e)) return '📊';
      if (/(json)$/.test(e)) return '🧩';
      if (/(md|txt)$/.test(e)) return '📝';
      if (/(html|htm)$/.test(e)) return '🌐';
      return '📁';
    };

    // --- RENDER FILTER CHIPS ---
    const renderChips = () => {
      const cats = Array.from(new Set(state.files.map(deriveCategory))).sort();
      const list = ['All', ...cats];
      filtersEl.innerHTML = '';
      list.forEach(name => {
        const c = document.createElement('button');
        c.className = 'chip' + (name === state.activeChip ? ' active' : '');
        c.textContent = name;
        c.onclick = () => { state.activeChip = name; renderTree(); };
        filtersEl.appendChild(c);
      })
    };

    // --- RENDER TREE ---
    const renderTree = () => {
      let items = state.files.slice();
      const qv = state.q.trim().toLowerCase();
      if (qv) {
        items = items.filter(f => (f.title || f.path).toLowerCase().includes(qv));
      }
      if (state.activeChip !== 'All') {
        items = items.filter(f => deriveCategory(f) === state.activeChip);
      }
      // Group by first two path segments for sanity
      const groups = new Map();
      for (const f of items) {
        const parts = f.path.split('/');
        const key = parts.slice(0, Math.min(2, parts.length-1)).join('/') || 'Root';
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(f);
      }
      [...groups.values()].forEach(arr => arr.sort(byPath));

      tree.innerHTML = '';
      for (const [key, arr] of groups) {
        const g = document.createElement('div');
        g.className = 'group';
        const h = document.createElement('h3');
        h.textContent = key;
        g.appendChild(h);
        for (const f of arr) {
          const a = document.createElement('a');
          a.className = 'file';
          a.href = hashFor(f.path);
          a.dataset.path = f.path;
          a.innerHTML = `<span class="icon">${iconFor(f.type || f.path)}</span><span class="name">${f.title || f.path.split('/').pop()}</span><span class="meta">${fmtBytes(f.size)}</span>`;
          a.addEventListener('click', (ev)=>{
            ev.preventDefault();
            selectFile(f.path, true);
          });
          g.appendChild(a);
        }
        tree.appendChild(g);
      }
      if (!items.length) {
        const d = document.createElement('div');
        d.className = 'empty';
        d.textContent = 'No matches.';
        tree.appendChild(d);
      }
    };

    // --- PREVIEW LOADER ---
    const fetchText = (url) => fetch(url, {cache:'no-store'}).then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.text();
    });

    const selectFile = async (path, pushHash=false) => {
      const f = state.files.find(x => x.path === path);
      if (!f) return;
      if (pushHash) location.hash = hashFor(path);
      crumbs.textContent = path;
      openRaw.disabled = false; copyLink.disabled = false;
      const rawUrl = f.url || toGitHubRaw(path);
      openRaw.onclick = () => window.open(rawUrl, '_blank', 'noopener');
      copyLink.onclick = async () => { await navigator.clipboard.writeText(location.href); copyLink.textContent = 'Copied'; setTimeout(()=> copyLink.textContent='Copy link', 1200); };

      const e = ext(path);
      viewer.innerHTML = '';

      try {
        if (["png","jpg","jpeg","gif","webp","svg"].includes(e)) {
          const img = new Image(); img.src = rawUrl; img.alt = path; img.style.maxWidth='100%'; img.style.display='block'; img.style.margin='0 auto';
          const wrap = document.createElement('div'); wrap.className='pad'; wrap.appendChild(img); viewer.appendChild(wrap);
          return;
        }
        if (["mp4","webm","mov","m4v"].includes(e)) {
          const v = document.createElement('video'); v.controls = true; v.src = rawUrl; v.style.width='100%'; viewer.appendChild(v); return;
        }
        if (["mp3","wav","ogg","m4a"].includes(e)) {
          const a = document.createElement('audio'); a.controls = true; a.src = rawUrl; const wrap = document.createElement('div'); wrap.className='pad'; wrap.appendChild(a); viewer.appendChild(wrap); return;
        }
        if (e === 'pdf') {
          const obj = document.createElement('object'); obj.type = 'application/pdf'; obj.data = rawUrl + '#view=FitH'; obj.innerHTML = '<div class="pad">PDF preview unavailable. Use "Open raw".</div>'; viewer.appendChild(obj); return;
        }
        if (e === 'html' || e === 'htm') {
          const ifr = document.createElement('iframe'); ifr.src = rawUrl; ifr.setAttribute('sandbox','allow-same-origin allow-forms allow-scripts'); viewer.appendChild(ifr); return;
        }
        if (e === 'json') {
          const txt = await fetchText(rawUrl);
          const pre = document.createElement('pre');
          try { pre.textContent = JSON.stringify(JSON.parse(txt), null, 2); }
          catch(_) { pre.textContent = txt; }
          viewer.appendChild(pre); return;
        }
        if (e === 'md') {
          const txt = await fetchText(rawUrl);
          const html = simpleMarkdown(txt);
          const container = document.createElement('div'); container.className='pad'; container.innerHTML = html; viewer.appendChild(container); return;
        }
        // default text
        const txt = await fetchText(rawUrl);
        const pre = document.createElement('pre'); pre.textContent = txt; viewer.appendChild(pre);
      } catch(err){
        viewer.innerHTML = `<div class="empty pad">Preview failed: ${err.message}. Use "Open raw".</div>`;
      }
    };

    function simpleMarkdown(src){
      // ultra-light MD: headings, bold/italics, code, links, lists, paragraphs
      let s = src
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      s = s.replace(/^######\s?(.*)$/gm,'<h6>$1</h6>')
           .replace(/^#####\s?(.*)$/gm,'<h5>$1</h5>')
           .replace(/^####\s?(.*)$/gm,'<h4>$1</h4>')
           .replace(/^###\s?(.*)$/gm,'<h3>$1</h3>')
           .replace(/^##\s?(.*)$/gm,'<h2>$1</h2>')
           .replace(/^#\s?(.*)$/gm,'<h1>$1</h1>')
           .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
           .replace(/\*(.*?)\*/g,'<em>$1</em>')
           .replace(/`([^`]+)`/g,'<code>$1</code>')
           .replace(/\n\s*\n/g,'</p><p>')
           .replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
      // lists
      s = s.replace(/(^|\n)[\-\*] (.*?)(?=\n[^\-\* ]|$)/gs, (m,p1,block)=>{
        const items = block.split(/\n[\-\*] /).map((x,i)=> (i?x:block).trim());
        return `${p1}<ul>`+items.map(li=>`<li>${li}</li>`).join('')+`</ul>`;
      });
      return '<p>'+s+'</p>';
    }

    // GitHub raw URL fallback: assumes this page is served from a GH Pages repo
    function toGitHubRaw(path){
      // Try to infer from current location: https://{user}.github.io/{repo}/
      const {host, pathname} = location;
      const parts = pathname.split('/').filter(Boolean);
      const repo = parts[0] || '';
      // Typical raw: https://raw.githubusercontent.com/{user}/{repo}/main/{path}
      // We cannot know user or branch reliably; try current origin path first
      return (location.origin + '/' + path).replace(/\/+/, '/');
    }

    // Keyboard
    window.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='k') { e.preventDefault(); q.focus(); q.select(); }
    });

    q.addEventListener('input', () => { state.q = q.value; renderTree(); });

    window.addEventListener('hashchange', ()=>{
      const p = getHashFile(); if (p) selectFile(p, false);
    });

    async function boot(){
      let manifest;
      try {
        const res = await fetch('manifest.json', {cache:'no-store'});
        if (!res.ok) throw new Error('manifest.json not found');
        manifest = await res.json();
      } catch(err){
        // Try alternate path (e.g., under /data/manifest.json)
        try {
          const res2 = await fetch('data/manifest.json', {cache:'no-store'});
          if (!res2.ok) throw new Error('data/manifest.json not found');
          manifest = await res2.json();
        } catch(err2){
          tree.innerHTML = `<div class="empty pad">Cannot load manifest.json. (${err.message})</div>`;
          return;
        }
      }

      // Normalize manifest: accept many shapes (array, {files:[]}, {items:[]}, {entries:[]}, {data:[]}, {rows:[]})
      function extractFiles(manifest){
        if (Array.isArray(manifest)) return manifest;
        const candidates = [manifest.files, manifest.items, manifest.entries, manifest.data, manifest.rows];
        for (const c of candidates){ if (Array.isArray(c)) return c; }
        // Last resort: if the first enumerable value is an array, use it
        for (const k of Object.keys(manifest||{})){
          if (Array.isArray(manifest[k])) return manifest[k];
        }
        return [];
      }

      const rawFiles = extractFiles(manifest);
      const baseUrl = manifest.baseUrl || manifest.base_url || '';

      state.files = rawFiles.map(f => {
        const p = f.path || f.filepath || f.key || f.name;
        const guessedType = (f.type || f.mimetype || f.mime || (p? p.split('.').pop() : ''));
        let u = f.url || f.raw_url || f.downloadRaw || f.downloadCdn;
        if (!u && baseUrl && p){ try { u = new URL(p, baseUrl).toString(); } catch(_){} }
        return {
          path: p,
          url: u,
          size: f.size,
          type: guessedType,
          title: f.title || f.label,
          category: f.category,
          sha: f.sha
        };
      }).filter(x => !!x.path);

      if (!state.files.length){
        console.warn('[Aquifer] Manifest loaded but contained 0 files. Keys present:', Object.keys(manifest));
      }

      renderChips();
      renderTree();

      const initial = getHashFile();
      if (initial) selectFile(initial, false);
    }

    boot();
  })();
  </script>
</body>
</html>
